<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tapendos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® Tapendos</h1>
        <p class="subtitle">Tap to trigger vibration on your Nintendo Joy-Con</p>
        
        <div id="status" class="status disconnected">
            Disconnected
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="lengthSlider">
                    Length: <span id="lengthValue">10</span>ms
                </label>
                <input type="range" id="lengthSlider" min="10" max="2000" value="10" step="10">
            </div>

            <div class="control-group">
                <label for="intensitySlider">
                    Intensity: <span id="intensityValue">0.5</span>
                </label>
                <input type="range" id="intensitySlider" min="0" max="1" value="0.5" step="0.1">
            </div>

            <div class="control-group">
                <label for="pauseSlider">
                    Pause: <span id="pauseValue">0</span>ms
                </label>
                <input type="range" id="pauseSlider" min="0" max="1000" value="0" step="50">
            </div>

            <div class="control-group">
                <label for="repeatModeSelect">
                    Repeat Mode:
                </label>
                <select id="repeatModeSelect">
                    <option value="unlimited">Unlimited</option>
                    <option value="count">Count</option>
                </select>
            </div>

            <div class="control-group" id="repeatCountGroup" style="display: none;">
                <label for="repeatCountInput">
                    Repeat Count: <span id="repeatCountValue">1</span>
                </label>
                <input type="number" id="repeatCountInput" min="1" value="1" step="1">
            </div>
        </div>

        <div class="button-group">
            <div class="connect-buttons-row">
                <button id="connectLeftBtn" class="connect-btn">
                    <span class="check-indicator">[ ]</span> Connect Left
                </button>
                <button id="connectRightBtn" class="connect-btn">
                    <span class="check-indicator">[ ]</span> Connect Right
                </button>
            </div>
            <button id="vibrateBtn" class="vibrate-btn" disabled>Vibrate</button>
            <button id="stopBtn" class="stop-btn" style="display: none;">Stop</button>
        </div>

        <div class="info">
            <strong>Instructions:</strong><br>
            1. Click "Connect Joy-Con" and select your left and/or right Joy-Con(s) from the device list<br>
            2. Once connected, click "Vibrate" to start alternating vibration pattern<br>
            3. Pattern: Left buzz â†’ Pause â†’ Right buzz â†’ Pause â†’ (repeat)<br>
            4. Make sure your Joy-Con(s) are paired with your computer via Bluetooth
        </div>
    </div>

    <script type="module">
        import { JoyCon } from './joycon.mjs';

        // UI Management
        const connectLeftBtn = document.getElementById('connectLeftBtn');
        const connectRightBtn = document.getElementById('connectRightBtn');
        const vibrateBtn = document.getElementById('vibrateBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');

        const lengthSlider = document.getElementById('lengthSlider');
        const lengthValue = document.getElementById('lengthValue');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const pauseSlider = document.getElementById('pauseSlider');
        const pauseValue = document.getElementById('pauseValue');
        const repeatModeSelect = document.getElementById('repeatModeSelect');
        const repeatCountGroup = document.getElementById('repeatCountGroup');
        const repeatCountInput = document.getElementById('repeatCountInput');
        const repeatCountValue = document.getElementById('repeatCountValue');

        let joyCon = null;
        let currentRumbleAbortController = null;
        let currentRumblePromise = null;

        // Update value displays when sliders change and apply live config
        lengthSlider.addEventListener('input', (e) => {
            lengthValue.textContent = e.target.value;
            applyLiveConfig();
        });

        intensitySlider.addEventListener('input', (e) => {
            intensityValue.textContent = e.target.value;
            applyLiveConfig();
        });

        pauseSlider.addEventListener('input', (e) => {
            pauseValue.textContent = e.target.value;
            applyLiveConfig();
        });

        repeatModeSelect.addEventListener('change', (e) => {
            const isCountMode = e.target.value === 'count';
            repeatCountGroup.style.display = isCountMode ? 'block' : 'none';
            applyLiveConfig();
        });

        repeatCountInput.addEventListener('input', (e) => {
            const value = Math.max(1, parseInt(e.target.value, 10) || 1);
            repeatCountValue.textContent = value;
            e.target.value = value;
            applyLiveConfig();
        });

        function getCurrentConfig() {
            return {
                duration: parseInt(lengthSlider.value, 10),
                amplitude: parseFloat(intensitySlider.value),
                pauseDuration: parseInt(pauseSlider.value, 10),
                repeatMode: repeatModeSelect.value,
                repeatCount: parseInt(repeatCountInput.value, 10) || 1,
            };
        }

        async function applyLiveConfig() {
            if (joyCon?.isVibrating && currentRumbleAbortController) {
                // Cancel current rumble and start new one with updated config
                currentRumbleAbortController.abort();
                currentRumbleAbortController = null;
                
                // Wait a moment for cleanup, then start new rumble
                await new Promise(resolve => setTimeout(resolve, 10));
                
                if (joyCon?.isConnected) {
                    startRumble();
                }
            }
        }

        function updateUI(state, error = null) {
            if (error) {
                statusDiv.textContent = error;
                statusDiv.className = 'status error';
            } else {
                let statusText = 'Disconnected';
                if (state.connected) {
                    const deviceStatus = [];
                    if (state.devices) {
                        if (state.devices.left) deviceStatus.push('Left: Connected');
                        else deviceStatus.push('Left: Disconnected');
                        if (state.devices.right) deviceStatus.push('Right: Connected');
                        else deviceStatus.push('Right: Disconnected');
                    } else {
                        deviceStatus.push(state.deviceName || 'Joy-Con');
                    }
                    statusText = deviceStatus.join(', ');
                    if (state.vibrating) {
                        statusText += ' (Vibrating...)';
                    }
                }
                statusDiv.textContent = statusText;
                statusDiv.className = `status ${state.connected ? 'connected' : 'disconnected'}`;
            }
            
            // Update button states
            if (state.devices) {
                const leftIndicator = connectLeftBtn.querySelector('.check-indicator');
                const rightIndicator = connectRightBtn.querySelector('.check-indicator');
                
                if (state.devices.left) {
                    connectLeftBtn.textContent = '';
                    leftIndicator.textContent = '[âœ“]';
                    connectLeftBtn.appendChild(leftIndicator);
                    connectLeftBtn.appendChild(document.createTextNode(' Disconnect Left'));
                    connectLeftBtn.classList.add('connected');
                } else {
                    connectLeftBtn.textContent = '';
                    leftIndicator.textContent = '[ ]';
                    connectLeftBtn.appendChild(leftIndicator);
                    connectLeftBtn.appendChild(document.createTextNode(' Connect Left'));
                    connectLeftBtn.classList.remove('connected');
                }
                connectLeftBtn.disabled = state.vibrating;
                
                if (state.devices.right) {
                    connectRightBtn.textContent = '';
                    rightIndicator.textContent = '[âœ“]';
                    connectRightBtn.appendChild(rightIndicator);
                    connectRightBtn.appendChild(document.createTextNode(' Disconnect Right'));
                    connectRightBtn.classList.add('connected');
                } else {
                    connectRightBtn.textContent = '';
                    rightIndicator.textContent = '[ ]';
                    connectRightBtn.appendChild(rightIndicator);
                    connectRightBtn.appendChild(document.createTextNode(' Connect Right'));
                    connectRightBtn.classList.remove('connected');
                }
                connectRightBtn.disabled = state.vibrating;
            } else {
                connectLeftBtn.disabled = false;
                connectRightBtn.disabled = false;
            }
            
            vibrateBtn.disabled = !state.connected || state.vibrating;

            // Show/hide stop button
            stopBtn.style.display = state.vibrating ? 'block' : 'none';
        }

        function handleStateChange(state) {
            updateUI(state);
        }

        async function handleConnectLeft() {
            if (!joyCon) {
                joyCon = new JoyCon(handleStateChange);
            }

            try {
                const state = joyCon.devices;
                if (state.left) {
                    await joyCon.disconnectLeft();
                } else {
                    await joyCon.connectLeft();
                }
            } catch (error) {
                const currentState = joyCon ? {
                    connected: joyCon.isConnected,
                    vibrating: joyCon.isVibrating,
                    deviceName: joyCon.deviceName,
                    devices: joyCon.devices
                } : { connected: false, vibrating: false, deviceName: 'Joy-Con', devices: { left: false, right: false } };
                updateUI(currentState, `Error: ${error.message}`);
            }
        }

        async function handleConnectRight() {
            if (!joyCon) {
                joyCon = new JoyCon(handleStateChange);
            }

            try {
                const state = joyCon.devices;
                if (state.right) {
                    await joyCon.disconnectRight();
                } else {
                    await joyCon.connectRight();
                }
            } catch (error) {
                const currentState = joyCon ? {
                    connected: joyCon.isConnected,
                    vibrating: joyCon.isVibrating,
                    deviceName: joyCon.deviceName,
                    devices: joyCon.devices
                } : { connected: false, vibrating: false, deviceName: 'Joy-Con', devices: { left: false, right: false } };
                updateUI(currentState, `Error: ${error.message}`);
            }
        }

        async function startRumble() {
            if (!joyCon?.isConnected) {
                return;
            }

            if (typeof joyCon.rumble !== 'function') {
                updateUI({ 
                    connected: true, 
                    vibrating: false, 
                    deviceName: joyCon.deviceName,
                    devices: joyCon.devices
                }, 'Error: rumble method not available');
                return;
            }

            const config = getCurrentConfig();
            const abortController = new AbortController();
            currentRumbleAbortController = abortController;

            try {
                currentRumblePromise = joyCon.rumble({
                    lowFreq: 600,
                    highFreq: 600,
                    amplitude: config.amplitude,
                    duration: config.duration,
                    repeatMode: config.repeatMode,
                    repeatCount: config.repeatCount,
                    pauseDuration: config.pauseDuration,
                }, abortController.signal);

                await currentRumblePromise;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    updateUI({ 
                        connected: joyCon.isConnected, 
                        vibrating: false, 
                        deviceName: joyCon.deviceName,
                        devices: joyCon.devices
                    }, `Vibration error: ${error.message}`);
                }
            } finally {
                if (currentRumbleAbortController === abortController) {
                    currentRumbleAbortController = null;
                    currentRumblePromise = null;
                }
            }
        }

        async function handleVibrate() {
            await startRumble();
        }

        function handleStop() {
            if (currentRumbleAbortController) {
                currentRumbleAbortController.abort();
                currentRumbleAbortController = null;
            }
            if (joyCon) {
                joyCon.stop();
            }
        }

        connectLeftBtn.addEventListener('click', handleConnectLeft);
        connectRightBtn.addEventListener('click', handleConnectRight);
        vibrateBtn.addEventListener('click', handleVibrate);
        stopBtn.addEventListener('click', handleStop);

        // Initialize UI
        updateUI({ connected: false, vibrating: false, deviceName: 'Joy-Con', devices: { left: false, right: false } });

        if (!navigator.hid) {
            statusDiv.textContent = 'WebHID not supported. Use Chrome/Edge 89+';
            connectLeftBtn.disabled = true;
            connectRightBtn.disabled = true;
        } else {
            navigator.hid.addEventListener('disconnect', (event) => {
                if (joyCon) {
                    joyCon.handleDisconnect(event.device);
                }
            });
        }
    </script>
</body>
</html>

